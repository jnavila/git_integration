#!/bin/bash

usage(){
	echo "Usage: $0"
	exit 1
}

if [ -z $(which git-test-sequence) ]; then
    echo "git-test-sequence must be installed"
    exit 1;    
fi

build_cmd=$(git config integration.cmd)

if [ -z "$build_cmd" ]; then
    echo "please define config integration.cmd"
    exit 1;
fi

sequence_origin=$(git config integration.origin)
if [ -z "$sequence_origin" ]; then
    echo "please define config integration.origin"
    exit 1;
fi
    
workinghead=$(git symbolic-ref HEAD 2> /dev/null | cut -b 12-)

PRIVATE_BUILD=$(git rev-parse --show-toplevel)/.privatebuild

if [ ! -d "$PRIVATE_BUILD" ]; then
  git clone . "$PRIVATE_BUILD"
fi

cd "$PRIVATE_BUILD"
git clean -df
git fetch origin

git-test-sequence origin/${sequence_origin}..origin/$workinghead "$build_cmd"

if [ $? -eq 0 ]; then
    tput setaf 2
    echo "Integration OK"
    tput sgr0
else
    tput bold; tput setaf 1
    echo "Integration Failed!"
    tput sgr0
    exit $?
fi

cd -